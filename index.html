<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TaskLedger</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Loading Indicator -->
  <div class="loading-indicator" id="loadingIndicator">
    <div class="loading-bar"></div>
    <div class="loading-text">Syncing data...</div>
  </div>

  <div class="app-container" id="appContainer">
    <nav class="sidebar">
      <div class="sidebar-header">
        <h2 class="sidebar-logo">TL</h2>
        <h2 class="sidebar-title">TaskLedger</h2>
      </div>
      <ul class="nav-links">
        <li><a href="#" class="nav-link active" data-view="tasks">
          <span class="nav-icon">âœ…</span>
          <span class="nav-text">Tasks</span>
        </a></li>
        <li><a href="#" class="nav-link" data-view="memos">
          <span class="nav-icon">ğŸ“</span>
          <span class="nav-text">Memos</span>
        </a></li>
        <li><a href="#" class="nav-link" data-view="needs">
          <span class="nav-icon">ğŸ“Œ</span>
          <span class="nav-text">Needs</span>
        </a></li>
        <li><a href="#" class="nav-link" data-view="review">
          <span class="nav-icon">ğŸ”</span>
          <span class="nav-text">Review</span>
          <span class="review-badge" id="reviewBadge" style="display: none;">0</span>
        </a></li>
        <li><a href="#" class="nav-link" data-view="updates">
          <span class="nav-icon">ğŸ“£</span>
          <span class="nav-text">Updates</span>
        </a></li>
        <li><a href="#" class="nav-link" data-view="files">
          <span class="nav-icon">ï¿½</span>
          <span class="nav-text">Resources</span>
        </a></li>
        <li><a href="#" class="nav-link" data-view="completed">
          <span class="nav-icon">ğŸ‰</span>
          <span class="nav-text">Completed</span>
        </a></li>
        <li><a href="#" class="nav-link" data-view="completed-needs">
          <span class="nav-icon">âœ…</span>
          <span class="nav-text">Completed Needs</span>
          <span class="completed-needs-badge" id="completedNeedsBadge" style="display: none;">0</span>
        </a></li>
      </ul>
      <div class="sidebar-footer">
        <button class="message-btn" onclick="openMessageModal()">
          <span class="nav-icon">ğŸ’¬</span>
          <span class="nav-text">Send Message</span>
        </button>
        <button class="logout-btn" onclick="logout()">
          <span class="nav-icon">ğŸ‘¤</span>
          <span class="nav-text" id="currentUserName">User</span>
        </button>
      </div>
      <button class="notifications-trigger" onclick="toggleNotificationsPanel()" aria-label="Open notifications panel" aria-expanded="false">
        <span class="notification-icon">ğŸ””</span>
        <span class="notification-badge" id="notificationBadge" style="display: none;" aria-live="polite">0</span>
      </button>
      <button class="completed-bin-trigger" onclick="toggleCompletedBin()" aria-label="Open completed items bin" title="Completed Items">
        <span class="bin-icon">ğŸ—‘ï¸</span>
        <span class="bin-badge" id="completedBinBadge" style="display: none;">0</span>
      </button>
    </nav>

    <aside class="notifications-panel" id="notificationsPanel" role="complementary" aria-label="Notifications">
      <div class="notifications-header">
        <h3>Notifications</h3>
        <div class="notifications-header-actions">
          <button class="clear-all-btn" onclick="clearAllNotifications()" aria-label="Clear all notifications">Clear All</button>
          <button class="close-notifications" onclick="toggleNotificationsPanel()" aria-label="Close notifications panel">âœ•</button>
        </div>
      </div>
      <div class="notifications-body" id="notificationsList" role="list">
        <p class="no-notifications">No new notifications</p>
      </div>
    </aside>

    <aside class="completed-bin-panel" id="completedBinPanel" role="complementary" aria-label="Completed Items">
      <div class="bin-header">
        <h3>ğŸ“¦ Completed Items</h3>
        <button class="close-bin" onclick="toggleCompletedBin()" aria-label="Close completed bin">âœ•</button>
      </div>
      <div class="bin-body">
        <div class="bin-section">
          <h4>Completed Memos</h4>
          <div id="completedMemosList" class="completed-items-list"></div>
        </div>
        <div class="bin-section">
          <h4>Completed Needs</h4>
          <div id="completedNeedsList" class="completed-items-list"></div>
        </div>
        <div class="bin-section">
          <h4>âœ… Fulfilled Needs</h4>
          <div id="fulfilledNeedsList" class="completed-items-list"></div>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div id="tasks-view" class="view active">
        <div class="view-header">
          <h1>Task Board</h1>
          <button class="add-task-btn" onclick="openAddTaskModal()">+ Add Task</button>
        </div>
        <section id="taskList"></section>
      </div>

      <div id="memos-view" class="view">
        <h1>Memos</h1>
        <section id="memoList"></section>
      </div>

      <div id="needs-view" class="view">
        <h1>Aggregated Needs</h1>
        <section id="needsList"></section>
      </div>
      <div id="review-view" class="view">
        <h1>Tasks Pending Review</h1>
        <p class="view-description">Review completed work and approve or request changes</p>
        <section id="reviewList"></section>
      </div>
      <div id="completed-view" class="view">
        <h1>Completed Tasks</h1>
        <section id="completedList"></section>
      </div>

      <div id="updates-view" class="view">
        <h1>Updates Feed</h1>
        <section id="updatesList"></section>
      </div>

      <div id="files-view" class="view">
        <div class="view-header">
          <h1>Resources</h1>
          <button class="add-file-btn" onclick="openFileUploadModal()">+ Add Resource</button>
        </div>
        <p class="view-description">Permanent storage for files, links, and references. These are never auto-deleted.</p>
        <section id="filesList"></section>
      </div>

      <div id="completed-needs-view" class="view">
        <h1>âœ… Completed Needs</h1>
        <p class="view-description">Track all completed needs with detailed information about how they were fulfilled</p>
        <div class="completed-needs-filters">
          <button class="filter-btn active" onclick="filterCompletedNeeds('all')">All</button>
          <button class="filter-btn" onclick="filterCompletedNeeds('completed')">âœ“ Completed</button>
          <button class="filter-btn" onclick="filterCompletedNeeds('fulfilled')">âœ… Fulfilled</button>
        </div>
        <section id="completedNeedsList"></section>
      </div>
    </main>
  </div>

  <div id="addTaskModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Add New Task</h2>
      <input id="taskTitle" placeholder="Task title" />
      <div style="display: flex; align-items: flex-start; gap: 8px;">
        <textarea id="taskDescription" placeholder="Full memo/description for this task" style="flex:1;"></textarea>
        <button type="button" class="ai-refine-btn" onclick="refineWithAI('taskDescription')" title="Refine with AI">ğŸ¤– Refine</button>
      </div>
      <textarea id="taskNotes" placeholder="Private notes (not part of the memo)"></textarea>
      <textarea id="taskNeeds" placeholder="What I need from you (one per line)"></textarea>
      <div class="priority-selector">
        <label for="taskPriority">Task Priority (for boss to manage):</label>
        <select id="taskPriority" onchange="handlePriorityChange()">
          <option value="high">ğŸ”´ High - Urgent</option>
          <option value="medium" selected>ğŸŸ¡ Medium - Moderate</option>
          <option value="low">ğŸŸ¢ Low - Can wait</option>
        </select>
        <p class="priority-note">ğŸ’¡ Note: Each need can have its own priority flag that you can set in the Needs view</p>
      </div>
      <div class="deadline-selector">
        <label for="taskDeadline">Deadline:</label>
        <select id="taskDeadline">
          <option value="none">No deadline</option>
          <option value="tomorrow">Tomorrow</option>
          <option value="2days" selected>In 2 days</option>
          <option value="1week">In 1 week</option>
          <option value="2weeks">In 2 weeks</option>
          <option value="3weeks">In 3 weeks</option>
          <option value="1month">In 1 month</option>
          <option value="2months">In 2 months</option>
        </select>
      </div>
      <div class="file-attachment-section">
        <label>ğŸ“ Attach File (temporary - deleted on completion):</label>
        <input type="file" id="taskFileInput" />
        <div class="file-preview" id="taskFilePreview"></div>
      </div>
      <div class="modal-actions">
        <button onclick="addTask()">Add Task</button>
        <button class="secondary" onclick="closeAddTaskModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="completionModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Submit Task for Review</h2>
      <p id="completionTaskTitle" style="color: var(--muted); margin-bottom: 16px;"></p>
      
      <label for="completionNotes" style="display: block; margin-bottom: 6px; font-weight: 600;">Completion Summary:</label>
      <textarea id="completionNotes" placeholder="Hi Craig, I've completed this task. Here's what I did..." rows="5"></textarea>
      
      <div class="file-attachment-section">
        <label>ğŸ“ Attach Files (proof of completion):</label>
        <input type="file" id="completionFileInput" multiple />
        <div class="file-preview" id="completionFilePreview"></div>
      </div>
      
      <div class="media-section">
        <h4>ğŸ“¸ Additional Materials</h4>
        <div class="input-group">
          <label for="completionImageUrl">Image URL:</label>
          <input id="completionImageUrl" type="url" placeholder="https://example.com/screenshot.jpg" />
        </div>
        <div class="input-group">
          <label for="completionLinks">Related Links (one per line):</label>
          <textarea id="completionLinks" rows="3" placeholder="Documentation | https://...\nDemo | https://..." style="min-height: 60px;"></textarea>
          <small>Format: Link text | URL</small>
        </div>
      </div>
      
      <div class="modal-actions">
        <button onclick="submitForReview()">Submit for Review</button>
        <button class="secondary" onclick="closeCompletionModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="reviewFeedbackModal" class="modal-overlay">
    <div class="modal-content">
      <h2 id="reviewFeedbackTitle">Review Feedback</h2>
      <p id="reviewFeedbackTaskTitle" style="color: var(--muted); margin-bottom: 16px;"></p>
      <label for="reviewFeedbackNotes" style="display: block; margin-bottom: 6px; font-weight: 600;">Notes:</label>
      <textarea id="reviewFeedbackNotes" placeholder="Add feedback or request changes..." rows="5"></textarea>
      <div class="modal-actions">
        <button id="reviewActionBtn" onclick="submitReviewAction()">Submit</button>
        <button class="secondary" onclick="closeReviewFeedbackModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="updateModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Post Progress Update</h2>
      <p id="updateTaskTitle"></p>
      <textarea id="updateText" placeholder="What progress have you made on this task?"></textarea>
      <div class="modal-actions">
        <button onclick="saveUpdate()">Post Update</button>
        <button class="secondary" onclick="closeUpdateModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="memoModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Edit Memo</h2>
      <p id="memoTaskTitle"></p>
      <textarea id="memoText" placeholder="Enter detailed memo/description for this task..."></textarea>
      
      <div class="media-section">
        <h4>ğŸ“ Attachments</h4>
        <div class="media-inputs">
          <div class="input-group">            <label>ğŸ“„ File Upload (temporary - deleted on completion):</label>
            <input type="file" id="needsFileInput" />
            <div class="file-preview" id="needsFilePreview"></div>
          </div>
          <div class="input-group">            <label>ğŸ“„ File Upload (temporary - deleted on completion):</label>
            <input type="file" id="memoFileInput" />
            <div class="file-preview" id="memoFilePreview"></div>
          </div>
          <div class="input-group">
            <label for="memoImageUrl">Image URL:</label>
            <input id="memoImageUrl" type="url" placeholder="https://example.com/image.jpg" />
            <small>Or paste an image to upload:</small>
            <div id="memoImagePreview" class="image-preview"></div>
          </div>
          <div class="input-group">
            <label for="memoLinks">Links (one per line):</label>
            <textarea id="memoLinks" rows="3" placeholder="Link text | https://example.com\nAnother link | https://..." style="min-height: 60px;"></textarea>
            <small>Format: Link text | URL</small>
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button onclick="saveMemo()">Save Memo</button>
        <button class="secondary" onclick="closeMemoModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="needsModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Edit Needs</h2>
      <p id="needsTaskTitle"></p>
      <textarea id="needsText" placeholder="What you need from your boss (one per line)..."></textarea>
      <div class="needs-help-box">
        <p class="needs-help-text">ğŸ’¡ <strong>How to add needs:</strong></p>
        <ul class="needs-help-list">
          <li>Enter each need on a separate line</li>
          <li>Add priority: <code>[high]</code>, <code>[medium]</code>, or <code>[low]</code> after the text</li>
          <li>Example: <code>Review my code [high]</code></li>
          <li>If no priority specified, defaults to medium</li>
        </ul>
      </div>
      
      <div class="media-section">
        <h4>ğŸ“ Attachments for Needs</h4>
        <div class="media-inputs">
          <div class="input-group">
            <label for="needsImageUrl">Image URL:</label>
            <input id="needsImageUrl" type="url" placeholder="https://example.com/image.jpg" />
            <div id="needsImagePreview" class="image-preview"></div>
          </div>
          <div class="input-group">
            <label for="needsLinks">Links (one per line):</label>
            <textarea id="needsLinks" rows="3" placeholder="Link text | https://example.com\nAnother link | https://..." style="min-height: 60px;"></textarea>
            <small>Format: Link text | URL</small>
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button onclick="saveNeeds()">Save Needs</button>
        <button class="secondary" onclick="closeNeedsModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="notificationDetailModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Notification Details</h2>
      <div id="notificationDetailContent"></div>
      <div class="modal-actions">
        <button onclick="closeNotificationDetail()">Close</button>
      </div>
    </div>
  </div>

  <div id="messageModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Send Message</h2>
      <p id="messageRecipient"></p>
      <label for="messagePriority" style="display: block; margin-bottom: 6px; font-weight: 600;">Priority:</label>
      <select id="messagePriority" style="width: 100%; padding: 8px; margin-bottom: 12px; border-radius: 4px; border: 1px solid var(--border);">
        <option value="low">Low</option>
        <option value="normal" selected>Normal</option>
        <option value="high">High (Pop-up notification)</option>
      </select>
      <textarea id="messageText" placeholder="Type your message here..." rows="6"></textarea>
      <div class="modal-actions">
        <button onclick="sendMessage()">Send Message</button>
        <button class="secondary" onclick="closeMessageModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="sentConfirmation" class="sent-confirmation">
    Message sent! âœ“
  </div>

  <!-- High Priority Message Popup -->
  <div id="highPriorityPopup" class="modal-overlay" style="z-index: 10000;">
    <div class="modal-content" style="max-width: 500px; border: 3px solid #ff4444;">
      <h2 style="color: #ff4444; margin-bottom: 8px;">ğŸ”” High Priority Message</h2>
      <p id="highPriorityFrom" style="color: var(--muted); font-size: 0.9em; margin-bottom: 12px;"></p>
      <div id="highPriorityText" style="padding: 16px; background: var(--bg); border-radius: 6px; margin-bottom: 16px; white-space: pre-wrap;"></div>
      <div class="modal-actions">
        <button onclick="closeHighPriorityPopup()">Got it</button>
      </div>
    </div>
  </div>

  <div id="needCompletionModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Complete Need</h2>
      <p id="needCompletionTaskTitle" style="color: var(--muted); margin-bottom: 8px;"></p>
      <div class="need-completion-text" id="needCompletionText" style="padding: 12px; background: var(--bg); border-radius: 6px; margin-bottom: 16px;"></div>
      <label for="needCompletionNote" style="display: block; margin-bottom: 6px; font-weight: 600;">Completion Notes:</label>
      <textarea id="needCompletionNote" placeholder="Add details about how this need was fulfilled..." rows="4"></textarea>
      <label for="needCompletionLink" style="display: block; margin-bottom: 6px; margin-top: 12px; font-weight: 600;">Related Link (optional):</label>
      <input id="needCompletionLink" placeholder="https://..." type="url" />
      <div class="modal-actions">
        <button onclick="saveNeedCompletion()">Mark Complete</button>
        <button class="secondary" onclick="closeNeedCompletionModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="fulfillNeedModal" class="modal-overlay">
    <div class="modal-content">
      <h2>âœ… Fulfill Need</h2>
      <p id="fulfillNeedTaskTitle" style="color: var(--muted); margin-bottom: 8px;"></p>
      <div class="need-completion-text" id="fulfillNeedText" style="padding: 12px; background: var(--bg); border-radius: 6px; margin-bottom: 16px;"></div>
      <label for="fulfillNeedNote" style="display: block; margin-bottom: 6px; font-weight: 600;">Fulfillment Notes:</label>
      <textarea id="fulfillNeedNote" placeholder="Describe how you've fulfilled this need..." rows="3"></textarea>
      <label for="fulfillContactDetails" style="display: block; margin-bottom: 6px; margin-top: 12px; font-weight: 600;">Contact Details / Client Info:</label>
      <textarea id="fulfillContactDetails" placeholder="Email, phone, client name, or other relevant contact information..." rows="2"></textarea>
      
      <label for="fulfillNeedLinks" style="display: block; margin-bottom: 6px; margin-top: 12px; font-weight: 600;">Related Links (optional):</label>
      <textarea id="fulfillNeedLinks" placeholder="Link Name | https://...\nAnother Link | https://..." rows="2"></textarea>
      <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">
        Format: <code>Link Name | URL</code> (one per line)
      </div>
      
      <label for="fulfillNeedFileInput" style="display: block; margin-bottom: 6px; margin-top: 12px; font-weight: 600;">Attach Files (optional):</label>
      <input type="file" id="fulfillNeedFileInput" multiple style="margin-bottom: 12px;" />
      <div id="fulfillNeedFilePreview" style="margin-bottom: 12px;"></div>
      
      <div class="modal-actions">
        <button onclick="saveFulfillNeed()">Submit Fulfillment</button>
        <button class="secondary" onclick="closeFulfillNeedModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="attachmentModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Add Link/Attachment</h2>
      <p id="attachmentTaskTitle"></p>
      <input id="attachmentName" placeholder="Link name (e.g., Project Doc, Email)" />
      <input id="attachmentUrl" placeholder="URL (https://...)" type="url" />
      <div class="modal-actions">
        <button onclick="saveAttachment()">Add Link</button>
        <button class="secondary" onclick="closeAttachmentModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="fileUploadModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Add Permanent Resource</h2>
      <p style="color: var(--muted); margin-bottom: 16px;">Add a file or link that will be stored permanently.</p>
      
      <input id="resourceLabel" placeholder="Resource name/description" />
      <input id="resourceTaskAssociation" placeholder="Related task (optional)" />
      
      <div class="resource-type-tabs" style="display: flex; gap: 8px; margin: 16px 0;">
        <button type="button" class="resource-tab active" onclick="switchResourceTab('file')" id="fileTab">ğŸ“„ Upload File</button>
        <button type="button" class="resource-tab" onclick="switchResourceTab('link')" id="linkTab">ğŸ”— Add Link</button>
      </div>
      
      <div id="fileResourceSection">
        <input type="file" id="permanentFileInput" />
        <div class="file-upload-progress" id="fileUploadProgress" style="display: none;">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <span class="progress-text" id="progressText">0%</span>
        </div>
      </div>
      
      <div id="linkResourceSection" style="display: none;">
        <input id="permanentLinkUrl" type="url" placeholder="https://example.com/document.pdf" />
        <small style="display: block; color: var(--muted); margin-top: 4px;">Any URL: documents, images, videos, websites, etc.</small>
      </div>
      
      <div class="modal-actions">
        <button onclick="uploadPermanentFile()">Save Resource</button>
        <button class="secondary" onclick="closeFileUploadModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- AI Chat Button -->
  <button class="chat-bot-button" id="chatBotButton" onclick="toggleChatBot()" title="Ask AI Assistant">
    <span class="chat-icon">ğŸ¤–</span>
  </button>

  <!-- AI Chat Modal -->
  <div id="chatBotModal" class="chat-bot-modal">
    <div class="chat-bot-container">
      <div class="chat-bot-header">
        <div class="chat-bot-title">
          <span class="chat-bot-icon">ğŸ¤–</span>
          <span>AI Assistant</span>
        </div>
        <button class="chat-close-btn" onclick="toggleChatBot()">âœ•</button>
      </div>
      <div class="chat-bot-messages" id="chatBotMessages">
        <div class="chat-message assistant">
          <div class="message-bubble">
            ğŸ‘‹ Hi! I'm your AI assistant. I can help you with questions about TaskLedger, retrieve information, or assist with anything else. Just ask!
          </div>
        </div>
      </div>
      <div class="chat-bot-input-area">
        <textarea id="chatBotInput" placeholder="Ask me anything..." rows="2" onkeydown="handleChatKeydown(event)"></textarea>
        <button onclick="sendChatMessage()" class="chat-send-btn" id="chatSendBtn">
          <span>Send</span>
        </button>
      </div>
    </div>
  </div>

  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="script.js"></script>
  
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js");
      });
    }
  </script>
</body>
</html>
